<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resource Mapping Report</title>

    <!-- OpenLayers CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.4.0/ol.css">

    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <!-- OpenLayers JS -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v10.4.0/dist/ol.js"></script>

    <!-- OpenLayers-ext JS -->
    <script src="https://cdn.jsdelivr.net/npm/ol-ext@4.0.27/dist/ol-ext.min.js"></script>

    <!-- OpenLayers-ext CSS -->
    <link href="https://cdn.jsdelivr.net/npm/ol-ext@4.0.27/dist/ol-ext.min.css" rel="stylesheet">

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
        }
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
            text-align: center;
        }
        h1, h2, h3 {
            margin-top: 0;
        }
        .section {
            margin-bottom: 40px;
            page-break-inside: avoid;
        }
        .map-group{
            width: 100%;
            display: flex;
            flex-direction: row;
            gap: 10px;
        }
        .map {
            height: 600px;
            width: 100%;
            margin: 20px 0;
            border: 1px solid #ddd;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 70vw;
            margin: 20px 0 10px 0;
        }
        .legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin: 10px 0;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 0 10px;
        }
        .legend-color {
            width: 15px;
            height: 15px;
            margin-right: 5px;
            border-radius: 2px;
        }
        footer {
            margin-top: 40px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
            text-align: center;
            color: #7f8c8d;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        /* Print Button Styles */
        .print-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            transition: background-color 0.3s;
        }
        
        .print-button:hover {
            background-color: #2ecc71;
        }
        
        .print-button svg {
            margin-right: 5px;
        }
        
        .doc-button {
            position: absolute;
            top: 20px;
            right: 140px; /* shift left of the PDF button */
            background-color: #0078d4;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            transition: background-color 0.3s;
        }

        .doc-button:hover { background-color: #005a9e; }
        
        @media print { .doc-button { display: none; } }

        /* Hide print button when printing */
        @media print {
            .print-button {
                display: none;
            }
        }

       /* Print-specific styles */
       @media print {
        .container {
            width: 100vw;
            max-width: none;
            padding: 0;
        }

        header {
            background-color: #2c3e50 !important;
            color: white !important;
            padding: 15px 0;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
      }

      
      /* --- PRINT FIX: keep first map on page 1 in landscape --- */
        @media print {
            @page { size: A4 landscape; margin: 10mm; }

            /* Compact the top heading area */
            header { padding: 6mm 0 !important; }
            header .container { padding: 0 10mm !important; }
            header h1 {
                font-size: 20pt !important;
                margin: 0 !important;
                line-height: 1.2 !important;
            }

            /* Let sections break if needed (prevents blank first page) */
            .section { page-break-inside: auto !important; }

            /* Ensure the first map fits on page 1 */
            #mainMap { height: 150mm !important; }

            /* Trim spacing so content fits better */
            .container { width: 100vw; max-width: none; padding: 0 10mm !important; }
            h2 { margin: 6mm 0 3mm 0 !important; }
            .map { margin: 6mm 0 !important; }
        }

    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Resource Report</h1>
            <button class="print-button" onclick="printReport()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="6 9 6 2 18 2 18 9"></polyline>
                    <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                    <rect x="6" y="14" width="12" height="8"></rect>
                </svg>
                Save as PDF
            </button>
        </div>


    </header>

    <div class="container">

        <section class="section">
            <h2>Settlement Overview</h2>
            <div id="mainMap" class="map"></div>
        </section>

    </div>

    <div class="container">

        <section class="section">
            <h2>Well Overview</h2>
            <div id="wellMap" class="map"></div>
        </section>

    </div>

    <div class="container">

        <section class="section">
            <h2>WaterStructures Overview</h2>
            <div id="waterStructureMap" class="map"></div>
        </section>

    </div>

    <footer>
        <div class="container">
            <p>Report generated on <span id="report-date"></span> | CoRE Stack Team</p>
            <p>
                Please do share your feedback with
                <a href="mailto:contact@core-stack.org">contact@core-stack.org</a>.
            </p>
        </div>
    </footer>

    <script>
    const baseLayer = new ol.layer.Tile({
        source: new ol.source.XYZ({
        url: `https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}`,
        maxZoom: 30,
        transition: 500,
        }),
        preload: 4,
        zIndex: 0
    });
    const view = new ol.View({
        center: [78.9, 23.6],
        zoom: 10,
        projection: "EPSG:4326",
        constrainResolution: true,
        smoothExtentConstraint: true,
        smoothResolutionConstraint: true,
    });

    const mainMap = new ol.Map({
        target: 'mainMap',
        layers: [baseLayer],
        view: new ol.View({
            center: [78.9, 23.6],
            zoom: 10,
            projection: "EPSG:4326",
            constrainResolution: true,
            smoothExtentConstraint: true,
            smoothResolutionConstraint: true,
        })
    });

    const wellMap = new ol.Map({
        target: 'wellMap',
        layers: [new ol.layer.Tile({
                    source: new ol.source.XYZ({
                        url: `https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}`,
                        maxZoom: 30,
                        transition: 500,
                    }),
                    preload: 4,
                })],
        view: new ol.View({
            center: [78.9, 23.6],
            zoom: 10,
            projection: "EPSG:4326",
            constrainResolution: true,
            smoothExtentConstraint: true,
            smoothResolutionConstraint: true,
        })
    }); 

    const waterStructureMap = new ol.Map({
        target: 'waterStructureMap',
        layers: [new ol.layer.Tile({
                    source: new ol.source.XYZ({
                        url: `https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}`,
                        maxZoom: 30,
                        transition: 500,
                    }),
                    preload: 4,
                })],
        view: new ol.View({
            center: [78.9, 23.6],
            zoom: 10,
            projection: "EPSG:4326",
            constrainResolution: true,
            smoothExtentConstraint: true,
            smoothResolutionConstraint: true,
        })
    }); 

    // --- Helpers
    function readFeaturesFromGeoJSON(data) {
        return new ol.format.GeoJSON().readFeatures(data, {
        dataProjection: 'EPSG:4326',         // WFS usually returns EPSG:4326
        featureProjection: view.getProjection() // match your map projection
        });
    }

    // --- 1) Add MWS layer first
    async function addMwsLayer() {
        const url = "https://geoserver.core-stack.org:8443/geoserver/mws_layers/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=mws_layers:deltaG_well_depth_{{district}}_{{block}}&outputFormat=application/json";
        const resp = await fetch(url);
        const data = await resp.json();

        const vectorSource = new ol.source.Vector({
        features: readFeaturesFromGeoJSON(data)
        });

        const styleFunction = feature => {
        const uid = feature.get('uid');
        let strokeColor = 'skyblue';
        let fillColor = 'rgba(135, 206, 235, 0.1)';

        if (uid === '{{mws_id}}') {
            strokeColor = 'yellow';
            fillColor = 'rgba(255, 255, 0, 0.4)';
        }

        return new ol.style.Style({
            stroke: new ol.style.Stroke({ color: strokeColor, width: 2 }),
            fill: new ol.style.Fill({ color: fillColor }),
        });
        };

        const mwsLayer = new ol.layer.Vector({
            source: vectorSource,
            style: styleFunction,
            zIndex: 10
        });

        mainMap.addLayer(mwsLayer);
        wellMap.addLayer(mwsLayer);
        waterStructureMap.addLayer(mwsLayer);

        // Center on MWS extent
        const arr = vectorSource.getExtent();
        const mapcenter = [(arr[0] + arr[2]) / 2, (arr[1] + arr[3]) / 2];
        mainMap.getView().setCenter(mapcenter);
        wellMap.getView().setCenter(mapcenter);
        waterStructureMap.getView().setCenter(mapcenter);
    }

    // --- 2) Add Settlement layer after MWS
    async function addSettlementLayer() {
        const svgMarkup = `{% include 'icons/settlement_icon.svg' %}`;
        const settlementIconUrl =
            'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgMarkup);

        const url =
            "https://geoserver.core-stack.org:8443/geoserver/resources/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=resources:settlement_{{plan_id}}_{{district}}_{{block}}&outputFormat=application/json";
        const resp = await fetch(url);
        const data = await resp.json();

        const vectorSource = new ol.source.Vector({
            features: readFeaturesFromGeoJSON(data) // ensure projections match your map
        });

        const settlementLayer = new ol.layer.Vector({
            source: vectorSource,
            style: (feature) => {
            const name = (feature.get('Settleme_1') || '').toString();
            return new ol.style.Style({
                image: new ol.style.Icon({
                    src: settlementIconUrl,
                    anchor: [0.5, 1],
                    anchorXUnits: 'fraction',
                    anchorYUnits: 'fraction',
                    scale: 0.4
                }),
                text: new ol.style.Text({
                    text: name,
                    font: '12px sans-serif',
                    textAlign: 'center',
                    fill: new ol.style.Fill({ color: '#111' }),
                    stroke: new ol.style.Stroke({ color: '#fff', width: 3 }),
                    overflow: true
                })
            });
            },
            zIndex: 20
        });

        mainMap.addLayer(settlementLayer);
    }

    async function addWellLayer() {
         const svgMarkup = `{% include 'icons/well_icon.svg' %}`;
        const wellIconsUrl =
            'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgMarkup);

        const url =
            "https://geoserver.core-stack.org:8443/geoserver/resources/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=resources:well_{{plan_id}}_{{district}}_{{block}}&outputFormat=application/json";
        const resp = await fetch(url);
        const data = await resp.json();

        const vectorSource = new ol.source.Vector({
            features: readFeaturesFromGeoJSON(data) // ensure projections match your map
        });

        const wellLayer = new ol.layer.Vector({
            source: vectorSource,
            style: (feature) => {
            const name = (feature.get('ben_settle') || '').toString();
            return new ol.style.Style({
                image: new ol.style.Icon({
                    src: wellIconsUrl,
                    anchor: [0.5, 1],
                    anchorXUnits: 'fraction',
                    anchorYUnits: 'fraction',
                    scale: 0.6
                }),
                text: new ol.style.Text({
                    text: name,
                    font: '12px sans-serif',
                    textAlign: 'center',
                    fill: new ol.style.Fill({ color: '#111' }),
                    stroke: new ol.style.Stroke({ color: '#fff', width: 3 }),
                    overflow: true
                })
            });
            },
            zIndex: 20
        });

        wellMap.addLayer(wellLayer);
    }

    async function addWaterLayer() {
         const svgMarkup = `{% include 'icons/waterbodiesScreenIcon.svg' %}`;
        const waterIconsUrl =
            'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgMarkup);

        const url =
            "https://geoserver.core-stack.org:8443/geoserver/resources/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=resources:waterbody_{{plan_id}}_{{district}}_{{block}}&outputFormat=application/json";
        const resp = await fetch(url);
        const data = await resp.json();

        const vectorSource = new ol.source.Vector({
            features: readFeaturesFromGeoJSON(data) // ensure projections match your map
        });

        const waterLayer = new ol.layer.Vector({
            source: vectorSource,
            style: (feature) => {
            const name = (feature.get('beneficiar') || '').toString();
            return new ol.style.Style({
                image: new ol.style.Icon({
                    src: waterIconsUrl,
                    anchor: [0.5, 1],
                    anchorXUnits: 'fraction',
                    anchorYUnits: 'fraction',
                }),
                text: new ol.style.Text({
                    text: name,
                    font: '12px sans-serif',
                    textAlign: 'center',
                    fill: new ol.style.Fill({ color: '#111' }),
                    stroke: new ol.style.Stroke({ color: '#fff', width: 3 }),
                    overflow: true
                })
            });
            },
            zIndex: 20
        });

        waterStructureMap.addLayer(waterLayer);
    }

    // Run in order
    (async function init() {
        try {
            await addMwsLayer();        // must finish first
            await addSettlementLayer(); // then add settlements
            await addWellLayer();
            await addWaterLayer();
        } catch (err) {
        console.error('Error building layers:', err);
        }
    })();

    // --- Report date & print handling (unchanged) ---
    const currentDate = new Date();
    const formattedDate = currentDate.toLocaleDateString('en-US', {
        year: 'numeric', month: 'long', day: 'numeric'
    });
    document.getElementById("report-date").textContent = formattedDate;

    function printReport() { window.print(); }

    window.addEventListener('beforeprint', function() {
        barChart.render();
        lineChart.render();
        pieChart.render();
    });

    window.addEventListener('afterprint', function() {
        setTimeout(function() { mainMap.updateSize(); }, 500);
    });
</script>

</body>
</html>